name: Deploy Discord Bot to Railway

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest
    
    - name: Install dependencies
      run: bun install
    
    - name: Build project
      run: bun run build
    
    - name: Run tests
      run: bun test
      
  deploy:
    needs: test
    runs-on: ubuntu-latest
    # Only deploy on pushes to main branch (not PRs)
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    # Use Railway's official CLI container for consistency
    container: ghcr.io/railwayapp/cli:latest
    
    env:
      RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
      DISCORD_TOKEN: ${{ secrets.DISCORD_TOKEN }}
      CHANNEL_ID: ${{ secrets.CHANNEL_ID }}
      TIMEZONE: ${{ secrets.TIMEZONE }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Verify Railway token
      run: |
        if [ -z "$RAILWAY_TOKEN" ]; then
          echo "‚ùå RAILWAY_TOKEN secret is not set"
          echo "Please add your Railway project token to GitHub repository secrets"
          exit 1
        fi
        echo "‚úÖ Railway token is configured"

    - name: Connect to Railway project
      run: |
        echo "üîó Connecting to Railway project..."
        # The RAILWAY_TOKEN should be automatically used by the CLI
        railway whoami || echo "‚ö†Ô∏è Could not verify Railway authentication"
        railway status || echo "‚ö†Ô∏è Could not get project status"
        
    - name: Verify Railway connection
      run: |
        echo "üîç Verifying Railway connection..."
        railway whoami || echo "‚ö†Ô∏è Could not verify Railway authentication"

    - name: Set Railway Environment Variables
      run: |
        echo "üîß Setting environment variables in Railway..."
        
        # Set environment variables using correct Railway CLI syntax
        if [ -n "$DISCORD_TOKEN" ]; then
          railway variables --set "DISCORD_TOKEN=$DISCORD_TOKEN" || echo "‚ö†Ô∏è Failed to set DISCORD_TOKEN"
          echo "‚úÖ DISCORD_TOKEN set in Railway"
        else
          echo "‚ö†Ô∏è DISCORD_TOKEN not found in GitHub Secrets"
        fi
        
        if [ -n "$CHANNEL_ID" ]; then
          railway variables --set "CHANNEL_ID=$CHANNEL_ID" || echo "‚ö†Ô∏è Failed to set CHANNEL_ID"
          echo "‚úÖ CHANNEL_ID set in Railway"
        else
          echo "‚ö†Ô∏è CHANNEL_ID not found in GitHub Secrets"
        fi
        
        if [ -n "$TIMEZONE" ]; then
          railway variables --set "TIMEZONE=$TIMEZONE" || echo "‚ö†Ô∏è Failed to set TIMEZONE"
          echo "‚úÖ TIMEZONE set in Railway"
        else
          echo "‚ÑπÔ∏è TIMEZONE not set, using default"
        fi

    - name: Deploy to Railway
      run: |
        echo "üöÄ Starting deployment to Railway..."
        
        # Check Railway CLI version and project status
        echo "üîç Railway CLI version:"
        railway --version || echo "Could not get version"
        
        echo "üìã Railway project status:"
        railway status || echo "Could not get status"
        
        # Deploy using service flag to avoid interactive prompts
        echo "üìã Deploying to Railway with service specification..."
        
        # Try common service names for Discord bots
        SERVICE_NAMES=("web" "app" "discord-bot" "gold-price-discord-bot" "main" "bot" "service")
        
        DEPLOYMENT_SUCCESS=false
        
        for service_name in "${SERVICE_NAMES[@]}"; do
          echo "üîç Trying to deploy to service: $service_name"
          
          if railway up --service "$service_name" --detach; then
            echo "‚úÖ Deployment successful to service: $service_name"
            DEPLOYMENT_SUCCESS=true
            break
          else
            echo "‚ö†Ô∏è Service '$service_name' not found or deployment failed"
          fi
        done
        
        # If all service names failed, try without service flag as last resort
        if [ "$DEPLOYMENT_SUCCESS" = false ]; then
          echo "‚ö†Ô∏è All service names failed, trying default deployment..."
          
          if railway up --detach; then
            echo "‚úÖ Default deployment successful!"
            DEPLOYMENT_SUCCESS=true
          else
            echo "‚ùå All deployment methods failed"
            echo "Railway status:"
            railway status
            exit 1
          fi
        fi
        
        echo "‚úÖ Deployment completed!"
        echo "üîó Check your Railway dashboard for deployment status"
    
    - name: Deployment notification
      if: success()
      run: |
        echo "üéâ Discord Bot deployed successfully to Railway!"
        echo "The bot should be running and ready to serve gold price updates."
    
    - name: Deployment failure notification
      if: failure()
      run: |
        echo "‚ùå Deployment failed!"
        echo "Please check the logs above and your Railway dashboard for more details." 