name: Deploy Discord Bot to Railway

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest
    
    - name: Install dependencies
      run: bun install
    
    - name: Build project
      run: bun run build
    
    - name: Run tests
      run: bun test
      
  deploy:
    needs: test
    runs-on: ubuntu-latest
    # Only deploy on pushes to main branch (not PRs)
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    # Use Railway's official CLI container for consistency
    container: ghcr.io/railwayapp/cli:latest
    
    env:
      RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Verify Railway token
      run: |
        if [ -z "$RAILWAY_TOKEN" ]; then
          echo "‚ùå RAILWAY_TOKEN secret is not set"
          echo "Please add your Railway project token to GitHub repository secrets"
          exit 1
        fi
        echo "‚úÖ Railway token is configured"
    
    - name: Deploy to Railway
      run: |
        echo "üöÄ Starting deployment to Railway..."
        
        # Deploy using Railway CLI
        # The --detach flag ensures the command doesn't wait for deployment to complete
        # This prevents GitHub Actions from timing out on long deployments
        railway up --detach
        
        echo "‚úÖ Deployment initiated successfully!"
        echo "üîó Check your Railway dashboard for deployment status"
    
    - name: Deployment notification
      if: success()
      run: |
        echo "üéâ Discord Bot deployed successfully to Railway!"
        echo "The bot should be running and ready to serve gold price updates."
    
    - name: Deployment failure notification
      if: failure()
      run: |
        echo "‚ùå Deployment failed!"
        echo "Please check the logs above and your Railway dashboard for more details." 